openapi: 3.1.0
info:
  title: Redispatching HTTP API (SSE + REST)
  version: '1.3.0'
  description: |
    API for TSO Redispatching Services using Server-Sent Events (SSE) for notifications and REST for data exchange.
    
    **Workflow:**
    1. Client connects to `/redispatch/{entityId}/stream`.
    2. **Resumption:** If the connection drops, the Client MUST reconnect providing the `Last-Event-ID` header with the ID of the last received event. The server will replay missed events.
    3. Client listens for `ORDER_ISSUED` events and `heartbeat` signals.
    4. When an `ORDER_ISSUED` event is received, Client fetches details via `GET`.
    5. Client sends confirmation and decision via `POST`.
servers:
  - url: https://api.tso.pl/v1
    description: Production Server


paths:
  # 1. NOTIFY: SSE Endpoint (Scoped by Entity)
  /redispatch/{entityId}/stream:
    get:
      summary: Subscribe to Order Issued Events
      description: |
        Opens a Server-Sent Events (SSE) stream for a specific entity.
        
        **Resumption:** To resume a broken connection without missing events, the client MUST provide the `Last-Event-ID` header containing the ID of the last event successfully processed. The server will replay events occurring after that ID.
      security:
        - oauth2: ["redispatch.read"]
      parameters:
        - name: entityId
          in: path
          required: true
          schema:
            type: string
          description: Unique 5-character identifier of the entity.
        - name: Last-Event-ID
          in: header
          required: false
          schema:
            type: string
          description: |
            The ID of the last event the client received. 
            If provided, the server will replay all subsequent events that occurred after this ID before sending new real-time events.
      responses:
        '200':
          description: Connection established.
          content:
            text/event-stream:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ConnectedEvent'
                  - $ref: '#/components/schemas/HeartbeatEvent'
                  - $ref: '#/components/schemas/RedispatchOrderIssuedEvent'
              examples:
                Connected:
                  summary: Initial Connected Event
                  value:
                    eventType: "connected"
                    connectionId: "550e8400-e29b-41d4-a716-446655440000"
                    timestamp: "2025-07-22T08:00:00Z"
                Heartbeat:
                  summary: Periodic Heartbeat
                  value:
                    eventType: "heartbeat"
                    timestamp: "2025-07-22T08:00:30Z"
                OrderIssued:
                  summary: Order Issued Event
                  value:
                    eventType: "ORDER_ISSUED"
                    redispatchOrderId: "1/I/22.07.2025"
                    entityId: "ENT01"
                    timestamp: "2025-07-22T08:01:00Z"
                    resourceUrl: "/redispatch/ENT01/orders/1%2FI%2F22.07.2025"

  # 2. GET: Retrieve Order Details (Scoped by Entity)
  /redispatch/{entityId}/orders/{redispatchOrderId}:
    get:
      summary: Get Redispatch Order Details
      description: Fetches the full technical details of a specific redispatch order.
      security:
        - oauth2: ["redispatch.read"]
      parameters:
        - name: entityId
          in: path
          required: true
          schema:
            type: string
        - name: redispatchOrderId
          in: path
          required: true
          schema:
            type: string
          description: The business ID of the order (URL encoded).
      responses:
        '200':
          description: Order details retrieved successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RedispatchOrder'
        '404':
          description: Order not found.

  # 3. ACKNOWLEDGE / DECIDE: Send Status (Scoped by Entity)
  /redispatch/{entityId}/orders/{redispatchOrderId}/acknowledgement:
    post:
      summary: Send Acknowledgement or Decision
      description: |
        Used for three stages of feedback:
        1. **Confirm Receipt:** Send status `RECEIVED` immediately after fetching the order.
        2. **Accept:** Send status `ACCEPTED` if the order can be realized.
        3. **Reject:** Send status `REJECTED` if the order cannot be realized.
      security:
        - oauth2: ["redispatch.write"]
      parameters:
        - name: entityId
          in: path
          required: true
          schema:
            type: string
        - name: redispatchOrderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RedispatchAcknowledgement'
      responses:
        '202':
          description: Acknowledgement accepted for processing.
        '400':
          description: Invalid acknowledgement format.

components:
  schemas:
    # --- Event Schemas ---
    RedispatchOrderIssuedEvent:
      type: object
      description: Notification sent via SSE when a new order is issued.
      required:
        - eventType
        - redispatchOrderId
        - entityId
        - timestamp
        - resourceUrl
      properties:
        eventType:
          type: string
          enum: [ORDER_ISSUED]
        redispatchOrderId:
          type: string
          description: The unique business identifier of the order.
          examples: ["1/I/22.07.2025"]
        entityId:
          type: string
          description: The 5-character entity identifier.
        timestamp:
          type: string
          format: date-time
        resourceUrl:
          type: string
          description: Relative URL to fetch the full order.
          examples: ["/redispatch/ENT01/orders/1%2FI%2F22.07.2025"]

    ConnectedEvent:
      type: object
      description: Initial event sent immediately after a successful connection.
      required:
        - eventType
        - connectionId
        - timestamp
      properties:
        eventType:
          type: string
          enum: [connected]
        connectionId:
          type: string
          description: Unique identifier for the current SSE session.
          format: uuid
        timestamp:
          type: string
          format: date-time

    HeartbeatEvent:
      type: object
      description: Periodic event sent to keep the connection alive.
      required:
        - eventType
        - timestamp
      properties:
        eventType:
          type: string
          enum: [heartbeat]
        timestamp:
          type: string
          format: date-time

    # --- Domain Schemas ---
    RedispatchOrder:
      type: object
      description: Full details of the redispatch order with flattened header data.
      required:
        - redispatchOrderId
        - entityId
        - issueOrderTs
        - redispatchOrderReason
        - redispatchOrderPeriod
        - redispatchOrders
      properties:
        redispatchOrderId:
          type: string
          description: "Business ID of the order"
          examples: ["1/I/22.07.2025"]
        entityId:
          type: string
          description: "Entity Identifier"
          minLength: 5
          maxLength: 5
        issueOrderTs:
          type: string
          format: date-time
          description: "Timestamp when the order was issued"
        redispatchOrderReason:
          type: string
          description: "Purpose: B - balancing, S - network"
          enum: [B, S]
        redispatchOrderPeriod:
          $ref: '#/components/schemas/RedispatchOrderPeriod'
        redispatchOrders:
          type: array
          minItems: 1
          description: "Array of technical redispatch details"
          items:
            $ref: '#/components/schemas/RedispatchOrderItem'

    RedispatchOrderItem:
      type: object
      required:
        - redispatchingObjectMrid
        - measurementUnit
        - curveType
        - seriesPeriods
      properties:
        redispatchingObjectMrid:
          type: string
          format: uuid
        measurementUnit:
          type: string
          enum: [ MAW ]
        curveType:
          type: string
          enum: [ A01 ]
        seriesPeriods:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - direction
              - autogenerationRedispatch
              - resolution
              - timeInterval
              - seriesPoints
            properties:
              direction:
                type: string
                enum: [ G, P ]
              autogenerationRedispatch:
                type: string
                enum: [ '0', '1' ]
              resolution:
                type: string
                enum: [ P1D, PT60M, PT15M ]
              timeInterval:
                $ref: '#/components/schemas/TimeInterval'
              seriesPoints:
                type: array
                items:
                  $ref: '#/components/schemas/SeriesPoint'

    RedispatchOrderPeriod:
      type: object
      required: [ startDt, endDt ]
      properties:
        startDt:
          type: string
          format: date-time
        endDt:
          type: string
          format: date-time

    TimeInterval:
      type: object
      required: [ startDt, endDt ]
      properties:
        startDt:
          type: string
          format: date-time
        endDt:
          type: string
          format: date-time

    SeriesPoint:
      type: object
      required: [ position, quantityMax, quantityMin ]
      properties:
        position:
          type: integer
        quantityMax:
          type: number
        quantityMin:
          type: number

    RedispatchAcknowledgement:
      type: object
      description: Acknowledgement payload sent by the entity.
      required:
        - redispatchOrderId
        - entityId
        - status
      properties:
        redispatchOrderId:
          type: string
          description: Reference to the order ID.
        entityId:
          type: string
          minLength: 5
          maxLength: 5
        status:
          type: string
          description: "Status: RECEIVED, ACCEPTED, REJECTED"
          enum: [ RECEIVED, ACCEPTED, REJECTED ]
        reason:
          type: string
          description: "Optional comment for the decision"
          maxLength: 512
  securitySchemes:
    oauth2:
      type: oauth2
      description: OAuth2 for B2B communication.
      flows:
        clientCredentials:
          tokenUrl: https://auth.example.com/oauth2/token
          scopes:
            "redispatch.read": "Scope to listen to events and fetch orders"
            "redispatch.write": "Scope to send acknowledgements"		  


